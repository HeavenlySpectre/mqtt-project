<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>MQTT Web Client with Auth & Latency</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.2/socket.io.js"></script>
</head>
<body class="bg-gray-100 text-gray-800 font-sans p-4 md:p-8">
    <div class="container mx-auto max-w-4xl">
        <h1 class="text-3xl font-bold mb-6 text-center text-blue-600">MQTT Web Client</h1>
        
        <!-- Login Form -->
        <div id="loginSection" class="bg-white p-6 rounded-lg shadow-md mb-6">
            <h2 class="text-xl font-semibold mb-4 text-gray-700">MQTT Login</h2>
            <div class="mb-4">
                <label for="mqttUsername" class="block text-sm font-medium text-gray-700 mb-1">MQTT Username:</label>
                <input type="text" id="mqttUsername" value="kelompoke" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
            </div>
            <div class="mb-4">
                <label for="mqttPassword" class="block text-sm font-medium text-gray-700 mb-1">MQTT Password:</label>
                <input type="password" id="mqttPassword" value="inites" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
            </div>
            <button id="loginButton" class="w-full bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-4 rounded-md">
                Login to MQTT
            </button>
            <div id="loginStatus" class="mt-3 text-sm"></div>
        </div>

        <!-- Main Controls and Messages (hidden initially) -->
        <div id="mainApp" style="display: none;">
            <div id="connectionStatus" class="mb-4 p-3 rounded-md text-center font-semibold"></div>
            <div class="text-right mb-2 text-sm">Logged in as: <span id="loggedInUser" class="font-semibold"></span> 
                <button id="logoutButton" class="ml-2 text-red-500 hover:text-red-700 text-xs">(Logout)</button>
            </div>

            <div class="flex flex-col md:flex-row gap-6">
                <div class="controls md:w-1/3 bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-xl font-semibold mb-4 text-gray-700">Controls</h2>
                    <div class="mb-4">
                        <label for="subscribeTopic" class="block text-sm font-medium text-gray-700 mb-1">Subscribe Topic:</label>
                        <div class="flex">
                            <input type="text" id="subscribeTopic" value="demo/features/#" class="flex-grow p-2 border border-gray-300 rounded-l-md focus:ring-blue-500 focus:border-blue-500">
                            <button id="subscribeButton" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-r-md">Subscribe</button>
                        </div>
                    </div>
                    <hr class="my-6 border-gray-200">
                    <div class="mb-4">
                        <label for="publishTopic" class="block text-sm font-medium text-gray-700 mb-1">Publish Topic:</label>
                        <input type="text" id="publishTopic" value="demo/features/web" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div class="mb-4">
                        <label for="publishPayload" class="block text-sm font-medium text-gray-700 mb-1">Payload:</label>
                        <textarea id="publishPayload" rows="3" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">Hello from Web!</textarea>
                    </div>
                    <div class="mb-4">
                        <label for="publishQos" class="block text-sm font-medium text-gray-700 mb-1">QoS:</label>
                        <input type="number" id="publishQos" value="0" min="0" max="2" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div class="mb-4 flex items-center">
                        <input type="checkbox" id="publishRetain" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500 mr-2">
                        <label for="publishRetain" class="text-sm font-medium text-gray-700">Retain Message</label>
                    </div>
                    <button id="publishButton" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-md">
                        Publish
                    </button>
                </div>

                <div class="messages md:w-2/3 bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-xl font-semibold mb-4 text-gray-700">Received Messages</h2>
                    <ul id="messageLog" class="h-96 overflow-y-auto border border-gray-200 rounded-md p-2 space-y-2">
                        <li class="text-gray-500 italic p-2" id="noMessagesPlaceholder">Login to see messages...</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script>
        const socket = io(); 

        // Login elements
        const loginSection = document.getElementById('loginSection');
        const mainAppSection = document.getElementById('mainApp');
        const mqttUsernameEl = document.getElementById('mqttUsername');
        const mqttPasswordEl = document.getElementById('mqttPassword');
        const loginButton = document.getElementById('loginButton');
        const loginStatusEl = document.getElementById('loginStatus');
        const loggedInUserEl = document.getElementById('loggedInUser');
        const logoutButton = document.getElementById('logoutButton');

        // Main app elements
        const connectionStatusEl = document.getElementById('connectionStatus');
        const subscribeTopicEl = document.getElementById('subscribeTopic');
        const subscribeButton = document.getElementById('subscribeButton');
        const publishTopicEl = document.getElementById('publishTopic');
        const publishPayloadEl = document.getElementById('publishPayload');
        const publishQosEl = document.getElementById('publishQos');
        const publishRetainEl = document.getElementById('publishRetain');
        const publishButton = document.getElementById('publishButton');
        const messageLogEl = document.getElementById('messageLog');
        const noMessagesPlaceholder = document.getElementById('noMessagesPlaceholder');
        let hasReceivedMessages = false;

        function updateStatus(message, type = 'info') {
            connectionStatusEl.textContent = message;
            const classesToRemove = Array.from(connectionStatusEl.classList).filter(
                cls => cls.startsWith('bg-') || cls.startsWith('text-')
            );
            connectionStatusEl.classList.remove(...classesToRemove);
            
            let bgColorClass = 'bg-blue-100 text-blue-700';
            if (type === 'success') bgColorClass = 'bg-green-100 text-green-700';
            else if (type === 'warning') bgColorClass = 'bg-yellow-100 text-yellow-700';
            else if (type === 'error') bgColorClass = 'bg-red-100 text-red-700';
            connectionStatusEl.classList.add(...bgColorClass.split(' '), 'mb-4', 'p-3', 'rounded-md', 'text-center', 'font-semibold');
        }
        
        function updateLoginStatus(message, isError = false) {
            loginStatusEl.textContent = message;
            loginStatusEl.className = `mt-3 text-sm ${isError ? 'text-red-600' : 'text-green-600'}`;
        }

        socket.on('connect', () => {
            console.log('Socket.IO: Connected to backend.');
            // Backend will send 'request_login'
        });
        
        socket.on('request_login', (data) => {
            console.log('Socket.IO: Backend requests login.', data.message);
            updateLoginStatus(data.message);
            loginSection.style.display = 'block';
            mainAppSection.style.display = 'none';
        });

        socket.on('login_status', (data) => {
            if (data.success) {
                updateLoginStatus(`Logged in as ${data.username}!`, false);
                loggedInUserEl.textContent = data.username;
                loginSection.style.display = 'none';
                mainAppSection.style.display = 'block';
                messageLogEl.innerHTML = '<li class="text-gray-500 italic p-2" id="noMessagesPlaceholder">Waiting for messages...</li>'; // Reset message log
                hasReceivedMessages = false;
            } else {
                updateLoginStatus(data.message, true);
            }
        });


        socket.on('disconnect', () => {
            updateStatus('Socket.IO Disconnected from Backend.', 'error');
            loginSection.style.display = 'block'; // Show login on disconnect
            mainAppSection.style.display = 'none';
            updateLoginStatus('Disconnected. Please login again.');
            console.log('Socket.IO: Disconnected from backend.');
        });
        
        socket.on('mqtt_status', (data) => {
            console.log('MQTT Status Update:', data);
            // Similar status update logic as before
            if (mainAppSection.style.display === 'block') { // Only update main status if logged in
                if (data.message.toLowerCase().includes('connected successfully') || data.message.toLowerCase().includes('connected as')) {
                    updateStatus(`MQTT: ${data.message}`, 'success');
                } else if (data.message.toLowerCase().includes('failed') || data.message.toLowerCase().includes('error') || data.message.toLowerCase().includes('disconnected')) {
                    updateStatus(`MQTT: ${data.message}`, 'error');
                } else if (data.message.toLowerCase().includes('connecting') || data.message.toLowerCase().includes('attempting')) {
                    updateStatus(`MQTT: ${data.message}`, 'warning');
                } else {
                    updateStatus(`MQTT: ${data.message}`, 'info');
                }
            }
        });

        socket.on('mqtt_message', (data) => {
            console.log('MQTT Message received via Socket.IO:', data);
            if (!hasReceivedMessages) {
                const placeholder = document.getElementById('noMessagesPlaceholder');
                if(placeholder) placeholder.style.display = 'none';
                hasReceivedMessages = true;
            }
            const listItem = document.createElement('li');
            listItem.className = 'p-3 bg-gray-50 rounded-md shadow-sm text-sm break-words';
            
            const escapedPayload = data.payload.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#39;");
            let latencyText = "";
            if (data.latency_ms !== null && data.latency_ms !== undefined) {
                latencyText = `<span class="text-purple-600">(Latency: ${data.latency_ms.toFixed(1)} ms)</span>`;
            }

            listItem.innerHTML = `<div class="font-semibold text-gray-700">Topic: <span class="font-normal text-indigo-600">${data.topic}</span> ${latencyText}</div>
                                  <pre class="mt-1 text-gray-600 whitespace-pre-wrap">${escapedPayload}</pre>
                                  <div class="mt-1 text-xs text-gray-500">
                                    QoS: ${data.qos} | Retain: ${data.retain ? 'Yes' : 'No'}
                                  </div>`;
            messageLogEl.prepend(listItem);
        });

        socket.on('publish_ack', (data) => {
            console.log('Publish ACK from server:', data.message);
        });

        loginButton.addEventListener('click', () => {
            const username = mqttUsernameEl.value.trim();
            const password = mqttPasswordEl.value; // Passwords can have spaces
            if (username && password) {
                updateLoginStatus('Attempting login...');
                socket.emit('web_login', { username: username, password: password });
            } else {
                updateLoginStatus('Username and password are required.', true);
            }
        });

        logoutButton.addEventListener('click', () => {
            socket.disconnect(); // This will trigger 'disconnect' on server and client
            // UI reset is handled by socket.on('disconnect')
        });

        subscribeButton.addEventListener('click', () => {
            const topic = subscribeTopicEl.value.trim();
            if (topic) {
                socket.emit('subscribe_to_topic', { topic: topic });
                console.log(`UI: Emitted 'subscribe_to_topic' for ${topic}`);
            } else {
                alert("Please enter a topic to subscribe to.");
            }
        });

        publishButton.addEventListener('click', () => {
            const topic = publishTopicEl.value.trim();
            const payload = publishPayloadEl.value;
            const qos = parseInt(publishQosEl.value, 10);
            const retain = publishRetainEl.checked;

            if (topic) {
                const clientPublishTimeMs = new Date().getTime(); // Timestamp for latency
                socket.emit('publish_mqtt_message', {
                    topic: topic,
                    payload: payload,
                    qos: qos,
                    retain: retain,
                    client_publish_time_ms: clientPublishTimeMs // Send to backend
                });
                console.log(`UI: Emitted 'publish_mqtt_message' to ${topic} with timestamp.`);
            } else {
                alert("Please enter a topic to publish to.");
            }
        });

        // Initial UI state
        loginSection.style.display = 'block';
        mainAppSection.style.display = 'none';
        updateLoginStatus('Please login with your MQTT credentials.');

    </script>
</body>
</html>