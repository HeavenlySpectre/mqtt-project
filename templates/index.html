<!-- START OF FILE index.html COMPLETE -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>MQTT - Modern Web Client</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ“¡</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.2/socket.io.js"></script>
    <style>
        .tooltip { position: relative; display: inline-block; cursor: help; }
        .tooltip .tooltiptext {
            visibility: hidden; background-color: #334155; color: #fff; text-align: center; 
            border-radius: 0.375rem; padding: 0.5rem 0.75rem; position: absolute; z-index: 50; 
            bottom: 130%; left: 50%; transform: translateX(-50%); opacity: 0; 
            transition: opacity 0.3s ease-in-out; font-size: 0.75rem; 
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06); 
            width: auto; min-width: 180px; white-space: nowrap;
        }
        .tooltip:hover .tooltiptext { visibility: visible; opacity: 1; }
        .spinner {
            border: 3px solid #e2e8f0; border-top: 3px solid #4f46e5; border-radius: 50%;
            width: 20px; height: 20px; animation: spin 0.8s linear infinite;
            display: inline-block; margin-left: 10px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #64748b; }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-100 to-sky-100 text-slate-700 font-sans p-4 md:p-8 min-h-screen">
    <div class="container mx-auto max-w-7xl">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-indigo-600 via-sky-500 to-teal-500">
                MQTTry Web Client
            </h1>
            {% if current_user.is_authenticated %}
            <div>
                <span class="text-sm text-slate-600 mr-3">Web User: <strong class="text-indigo-700">{{ current_user.username }}</strong></span>
                <a href="{{ url_for('web_logout_route') }}" 
                   class="bg-red-500 hover:bg-red-600 text-white font-medium py-2 px-4 rounded-lg text-sm transition-colors">
                    Web Logout
                </a>
            </div>
            {% endif %}
        </div>
        
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <div class="mb-6">
                {% for category, message in messages %}
                     <div class="p-3 rounded-md text-sm 
                                {% if category == 'danger' %} bg-red-100 text-red-700 
                                {% elif category == 'success' %} bg-green-100 text-green-700
                                {% elif category == 'warning' %} bg-yellow-100 text-yellow-700  
                                {% else %} bg-blue-100 text-blue-700 {% endif %}">
                        {{ message }}
                    </div>
                {% endfor %}
                </div>
            {% endif %}
        {% endwith %}

        <div id="mqttConnectionSection" class="bg-white p-8 rounded-xl shadow-2xl mb-8 max-w-2xl mx-auto">
            <h2 class="text-2xl font-bold text-slate-800 mb-6 text-center">Connect to MQTT Broker</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label for="mqttUsername" class="block text-sm font-medium text-slate-600 mb-1">MQTT Username</label>
                    <input type="text" id="mqttUsername" value="kelompoke" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-shadow">
                </div>
                <div>
                    <label for="mqttPassword" class="block text-sm font-medium text-slate-600 mb-1">MQTT Password</label>
                    <input type="password" id="mqttPassword" value="inites" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-shadow">
                </div>
            </div>
            <div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="flex items-center">
                    <input type="checkbox" id="useSecureConnection" checked class="h-5 w-5 text-indigo-600 border-slate-300 rounded focus:ring-indigo-500 mr-2">
                    <label for="useSecureConnection" class="text-sm font-medium text-slate-700">Use Secure Connection (MQTTS/WSS)</label>
                </div>
                <div class="flex items-center">
                    <input type="checkbox" id="useWebsockets" class="h-5 w-5 text-indigo-600 border-slate-300 rounded focus:ring-indigo-500 mr-2">
                    <label for="useWebsockets" class="text-sm font-medium text-slate-700">Use MQTT over WebSockets</label>
                </div>
            </div>
            <div id="websocketsOptions" class="mt-4 pl-1" style="display: none;">
                <label for="wsPath" class="block text-sm font-medium text-slate-600 mb-1">WebSocket Path</label>
                <input type="text" id="wsPath" value="/mqtt" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-shadow">
            </div>
             <div class="mt-6">
                <label for="connectTopicAliasMax" class="block text-sm font-medium text-slate-600 mb-1">Client Topic Alias Max (CONNECT)
                    <span class="tooltip text-xs text-slate-400">(?)<span class="tooltiptext">Max topic aliases client supports. 0 means no support. Broker may override.</span></span>
                </label>
                <input type="number" id="connectTopicAliasMax" value="10" min="0" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-shadow">
            </div>

            <fieldset class="mt-6 border border-slate-300 p-6 rounded-lg">
                <legend class="text-lg font-semibold text-slate-700 px-2">Last Will & Testament (LWT)</legend>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="lwtTopic" class="block text-sm font-medium text-slate-600 mb-1">LWT Topic</label>
                        <input type="text" id="lwtTopic" placeholder="client/status/mydevice" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-shadow">
                    </div>
                    <div>
                        <label for="lwtQos" class="block text-sm font-medium text-slate-600 mb-1">LWT QoS</label>
                        <select id="lwtQos" class="w-full p-3 border border-slate-300 rounded-lg bg-white focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-shadow">
                            <option value="0">0</option><option value="1" selected>1</option><option value="2">2</option>
                        </select>
                    </div>
                </div>
                <div class="mt-4">
                    <label for="lwtPayload" class="block text-sm font-medium text-slate-600 mb-1">LWT Payload</label>
                    <textarea id="lwtPayload" rows="2" placeholder="Device offline" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-shadow"></textarea>
                </div>
                <div class="mt-4 flex items-center">
                    <input type="checkbox" id="lwtRetain" class="h-5 w-5 text-indigo-600 border-slate-300 rounded mr-2 focus:ring-indigo-500">
                    <label for="lwtRetain" class="text-sm font-medium text-slate-700">Retain LWT Message</label>
                </div>
            </fieldset>
            <button id="connectMqttButton" class="mt-8 w-full bg-gradient-to-r from-teal-500 to-cyan-500 hover:from-teal-600 hover:to-cyan-600 text-white font-bold py-3 px-6 rounded-lg shadow-lg hover:shadow-xl transition-all duration-150 ease-in-out transform hover:scale-105 flex items-center justify-center text-lg">
                Connect to MQTT Broker <span id="mqttConnectSpinner" class="spinner" style="display: none;"></span>
            </button>
            <div id="mqttLoginStatus" class="mt-4 text-sm text-center h-5"></div> 
        </div>

        <div id="mainMqttApp" style="display: none;"> 
            <div id="connectionStatus" class="p-4 rounded-lg text-center font-semibold text-lg mb-6 shadow-md"></div>
            
            <div class="bg-white p-4 rounded-lg shadow-md mb-6 text-sm text-slate-600 flex flex-wrap justify-between items-center gap-y-2">
                <div>
                    MQTT User: <span id="loggedInMqttUser" class="font-semibold text-indigo-600"></span>
                    <span class="mx-1 text-slate-300">|</span>
                    MQTT Client ID: <span id="loggedInMqttClientId" class="font-mono text-xs text-indigo-500"></span>
                </div>
                <div class="flex items-center space-x-3">
                    <span>Transport: <span id="transportInfo" class="font-semibold text-slate-700"></span></span>
                    <span>Secure: <span id="secureInfo" class="font-semibold text-slate-700"></span></span>
                    <span>Broker Topic Alias Max: <span id="brokerTopicAliasMaxInfo" class="font-semibold text-slate-700">N/A</span></span>
                </div>
                <button id="disconnectMqttButton" class="bg-orange-100 text-orange-600 hover:bg-orange-200 font-medium py-2 px-4 rounded-lg text-xs transition-colors">Disconnect MQTT</button>
            </div>

            <div class="bg-white p-6 rounded-xl shadow-lg mb-6">
                <h2 class="text-2xl font-semibold text-slate-800 mb-6">Real-time Performance</h2>
                 <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                    <div class="p-4 bg-slate-50 rounded-lg shadow">
                        <div class="text-sm text-slate-500">Msg In/sec</div>
                        <div id="perfMsgInRate" class="font-bold text-2xl text-green-500">0.0</div>
                    </div>
                    <div class="p-4 bg-slate-50 rounded-lg shadow">
                        <div class="text-sm text-slate-500">Msg Out/sec</div>
                        <div id="perfMsgOutRate" class="font-bold text-2xl text-blue-500">0.0</div>
                    </div>
                    <div class="p-4 bg-slate-50 rounded-lg shadow">
                        <div class="text-sm text-slate-500">Data In/sec</div>
                        <div id="perfBytesInRate" class="font-bold text-2xl text-green-600">0 B</div>
                    </div>
                    <div class="p-4 bg-slate-50 rounded-lg shadow">
                        <div class="text-sm text-slate-500">Data Out/sec</div>
                        <div id="perfBytesOutRate" class="font-bold text-2xl text-blue-600">0 B</div>
                    </div>
                </div>
                <div class="mt-6 grid grid-cols-1 sm:grid-cols-3 gap-4 text-sm">
                    <div class="p-3 bg-red-50 rounded-lg text-center">Connect Errors: <span id="perfConnectErrors" class="font-bold text-red-600 text-lg">0</span></div>
                    <div class="p-3 bg-red-50 rounded-lg text-center">Publish Errors: <span id="perfPublishErrors" class="font-bold text-red-600 text-lg">0</span></div>
                    <div class="p-3 bg-red-50 rounded-lg text-center">Subscribe Failures: <span id="perfSubscribeFailures" class="font-bold text-red-600 text-lg">0</span></div>
                </div>
                <div class="mt-6 text-sm">
                    <span class="text-slate-500">Recent Message Latencies (ms):</span>
                    <span id="perfRecentLatencies" class="block font-mono text-purple-600 bg-purple-50 p-3 rounded-md mt-1 overflow-x-auto whitespace-nowrap">N/A</span>
                </div>
            </div>

            <div class="flex flex-col lg:flex-row gap-6">
                <div class="lg:w-2/5 xl:w-1/3 space-y-6">
                    <div class="bg-white p-6 rounded-xl shadow-lg">
                        <h2 class="text-xl font-semibold text-slate-800 mb-6">Publish Message</h2>
                        <div class="space-y-4">
                            <div>
                                <label for="publishTopic" class="block text-sm font-medium text-slate-600 mb-1">Topic
                                    <span class="tooltip text-xs text-slate-400">(?)<span class="tooltiptext">Leave blank if using Topic Alias > 0 and broker supports it.</span></span>
                                </label>
                                <input type="text" id="publishTopic" value="demo/features/web_publish" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-shadow">
                            </div>
                            <div>
                                <label for="publishPayload" class="block text-sm font-medium text-slate-600 mb-1">Payload</label>
                                <textarea id="publishPayload" rows="3" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-shadow">Hello from MQTTry!</textarea>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label for="publishQos" class="block text-sm font-medium text-slate-600 mb-1">QoS</label>
                                    <select id="publishQos" class="w-full p-3 border bg-white border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-shadow">
                                        <option value="0">0</option><option value="1" selected>1</option><option value="2">2</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="messageExpiry" class="block text-sm font-medium text-slate-600 mb-1">Expiry (sec)</label>
                                    <input type="number" id="messageExpiry" value="0" min="0" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-shadow" title="0 = no expiry">
                                </div>
                            </div>
                            <div>
                                <label for="publishTopicAlias" class="block text-sm font-medium text-slate-600 mb-1">Topic Alias
                                    <span class="tooltip text-xs text-slate-400">(?)<span class="tooltiptext">Set >0 to use. Must be <= Broker's Max. Topic field can be empty if alias is used and known by broker.</span></span>
                                </label>
                                <input type="number" id="publishTopicAlias" placeholder="e.g., 1 (optional)" min="0" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-shadow">
                            </div>
                            <div class="flex items-center">
                                <input type="checkbox" id="publishRetain" class="h-5 w-5 text-indigo-600 rounded mr-2 border-slate-300 focus:ring-indigo-500">
                                <label for="publishRetain" class="text-sm font-medium text-slate-700">Retain Message</label>
                            </div>
                            <button id="publishButton" class="w-full bg-gradient-to-r from-green-500 to-emerald-500 hover:from-green-600 hover:to-emerald-600 text-white font-semibold py-3 px-5 rounded-lg shadow-md hover:shadow-lg transition-all duration-150 transform hover:scale-105">Publish</button>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-xl shadow-lg">
                        <h2 class="text-xl font-semibold text-slate-800 mb-6">Subscribe (MQTTv5)</h2>
                        <div class="space-y-4">
                            <div>
                                <label for="subscribeTopic" class="block text-sm font-medium text-slate-600 mb-1">Topic</label>
                                <input type="text" id="subscribeTopic" value="demo/#" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-shadow" placeholder="e.g., demo/# or $share/group/topic">
                            </div>
                            <div>
                                <label for="subscribeQos" class="block text-sm font-medium text-slate-600 mb-1">QoS</label>
                                 <select id="subscribeQos" class="w-full p-3 bg-white border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-shadow">
                                    <option value="0">0</option><option value="1" selected>1</option><option value="2">2</option>
                                </select>
                            </div>
                            <fieldset class="border border-slate-200 p-4 rounded-lg">
                                <legend class="text-md font-medium text-slate-600 px-1">Options</legend>
                                <div class="mt-2 space-y-3">
                                    <div class="flex items-center">
                                        <input type="checkbox" id="subNoLocal" class="h-5 w-5 text-indigo-600 rounded mr-2 border-slate-300 focus:ring-indigo-500">
                                        <label for="subNoLocal" class="text-sm font-medium text-slate-700">No Local
                                            <span class="tooltip text-xs text-slate-400">(?)<span class="tooltiptext">Broker should not send messages published by this client back to this client.</span></span>
                                        </label>
                                    </div>
                                    <div class="flex items-center">
                                        <input type="checkbox" id="subRetainAsPublished" class="h-5 w-5 text-indigo-600 rounded mr-2 border-slate-300 focus:ring-indigo-500">
                                        <label for="subRetainAsPublished" class="text-sm font-medium text-slate-700">Retain As Published
                                            <span class="tooltip text-xs text-slate-400">(?)<span class="tooltiptext">When sending retained messages, broker should use the Retain flag from original publish.</span></span>
                                        </label>
                                    </div>
                                    <div>
                                        <label for="subRetainHandling" class="block text-sm font-medium text-slate-600 mb-1">Retain Handling
                                             <span class="tooltip text-xs text-slate-400">(?)<span class="tooltiptext">0: Send retained on subscribe. 1: Send if new subscription. 2: Do not send.</span></span>
                                        </label>
                                        <select id="subRetainHandling" class="w-full p-3 bg-white border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-shadow">
                                            <option value="0" selected>0 - Send on subscribe</option>
                                            <option value="1">1 - Send if new sub</option>
                                            <option value="2">2 - Do not send</option>
                                        </select>
                                    </div>
                                </div>
                            </fieldset>
                            <button id="subscribeButton" class="w-full bg-gradient-to-r from-sky-500 to-cyan-500 hover:from-sky-600 hover:to-cyan-600 text-white font-semibold py-3 px-5 rounded-lg shadow-md hover:shadow-lg transition-all duration-150 transform hover:scale-105">Subscribe</button>
                        </div>
                    </div>
                </div>

                <div class="lg:w-3/5 xl:w-2/3 space-y-6">
                    <div class="bg-white p-6 rounded-xl shadow-lg">
                        <h2 class="text-xl font-semibold text-slate-800 mb-6">Received Messages</h2>
                        <ul id="messageLog" class="h-96 overflow-y-auto border border-slate-200 bg-slate-50 rounded-lg p-4 space-y-3 custom-scrollbar">
                            <li class="text-slate-400 italic p-4 text-center" id="noMessagesPlaceholder">Connect to MQTT to see messages...</li>
                        </ul>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-lg">
                        <h2 class="text-xl font-semibold text-slate-800 mb-6">Request / Response</h2>
                        <div class="space-y-4">
                            <div>
                                <label for="targetClientId" class="block text-sm font-medium text-slate-600 mb-1">Target Client ID (Optional)
                                    <span class="tooltip text-xs text-slate-400">(?)<span class="tooltiptext">If filled, this becomes a direct request to the specified client ID.</span></span>
                                </label>
                                <input type="text" id="targetClientId" placeholder="Enter target client ID for direct request" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-shadow">
                            </div>
                            <div>
                                <label for="serviceOrTopicName" class="block text-sm font-medium text-slate-600 mb-1">Service Name / General Topic
                                    <span class="tooltip text-xs text-slate-400">(?)<span class="tooltiptext">If Target Client ID is set, this is the service/action name (e.g., 'echo'). Otherwise, it's the full topic for a general request.</span></span>
                                </label>
                                <input type="text" id="serviceOrTopicName" value="echo_service" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-shadow">
                            </div>
                            <div>
                                <label for="requestPayload" class="block text-sm font-medium text-slate-600 mb-1">Request Payload</label>
                                <textarea id="requestPayload" rows="2" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-shadow">Please echo this!</textarea>
                            </div>
                            <button id="sendRequestButton" class="w-full bg-gradient-to-r from-purple-500 to-fuchsia-500 hover:from-purple-600 hover:to-fuchsia-600 text-white font-semibold py-3 px-5 rounded-lg shadow-md hover:shadow-lg transition-all duration-150 transform hover:scale-105">Send Request</button>
                        </div>
                        <div id="requestResponseLog" class="mt-6 text-sm space-y-2 h-48 overflow-y-auto border border-slate-200 bg-slate-50 p-4 rounded-lg custom-scrollbar">
                            <p class="italic text-slate-400 text-center p-4" id="noReqResPlaceholder">Request/Response activity will appear here...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div> 
    </div>

    <script>
        const socket = io({ autoConnect: false }); 
        const DOM = {};
        let currentWebUser = "{{ current_user.username if current_user.is_authenticated else '' }}";
        let isMqttConnected = false; 
        let hasReceivedMessages = false;
        let firstReqResMessage = true;

        function setMqttUiState(connected) {
            isMqttConnected = connected;
            if (connected) {
                DOM.mqttConnectionSection.style.display = 'none';
                DOM.mainMqttApp.style.display = 'block';
            } else {
                DOM.mqttConnectionSection.style.display = 'block';
                DOM.mainMqttApp.style.display = 'none';
                if(DOM.mqttLoginStatus) DOM.mqttLoginStatus.textContent = 'Please connect to MQTT broker.';
                if(DOM.noMessagesPlaceholder) DOM.noMessagesPlaceholder.style.display = 'block';
                if(DOM.messageLogEl) DOM.messageLogEl.innerHTML = ''; hasReceivedMessages = false;
                if(DOM.noReqResPlaceholder) DOM.noReqResPlaceholder.style.display = 'block';
                if(DOM.requestResponseLogEl) DOM.requestResponseLogEl.innerHTML = ''; firstReqResMessage = true;
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            DOM.mqttConnectionSection = document.getElementById('mqttConnectionSection');
            DOM.mqttUsernameEl = document.getElementById('mqttUsername');
            DOM.mqttPasswordEl = document.getElementById('mqttPassword');
            DOM.useSecureConnectionEl = document.getElementById('useSecureConnection');
            DOM.useWebsocketsEl = document.getElementById('useWebsockets');
            DOM.websocketsOptionsEl = document.getElementById('websocketsOptions');
            DOM.wsPathEl = document.getElementById('wsPath');
            DOM.connectTopicAliasMaxEl = document.getElementById('connectTopicAliasMax');
            DOM.lwtTopicEl = document.getElementById('lwtTopic');
            DOM.lwtPayloadEl = document.getElementById('lwtPayload');
            DOM.lwtQosEl = document.getElementById('lwtQos');
            DOM.lwtRetainEl = document.getElementById('lwtRetain');
            DOM.connectMqttButton = document.getElementById('connectMqttButton'); 
            DOM.mqttConnectSpinner = document.getElementById('mqttConnectSpinner'); 
            DOM.mqttLoginStatus = document.getElementById('mqttLoginStatus'); 
            DOM.mainMqttApp = document.getElementById('mainMqttApp');
            DOM.loggedInMqttUser = document.getElementById('loggedInMqttUser'); 
            DOM.loggedInMqttClientId = document.getElementById('loggedInMqttClientId'); 
            DOM.transportInfoEl = document.getElementById('transportInfo');
            DOM.secureInfoEl = document.getElementById('secureInfo');
            DOM.brokerTopicAliasMaxInfoEl = document.getElementById('brokerTopicAliasMaxInfo');
            DOM.disconnectMqttButton = document.getElementById('disconnectMqttButton'); 
            DOM.connectionStatusEl = document.getElementById('connectionStatus');
            DOM.perfMsgInRateEl = document.getElementById('perfMsgInRate');
            DOM.perfMsgOutRateEl = document.getElementById('perfMsgOutRate');
            DOM.perfBytesInRateEl = document.getElementById('perfBytesInRate');
            DOM.perfBytesOutRateEl = document.getElementById('perfBytesOutRate');
            DOM.perfConnectErrorsEl = document.getElementById('perfConnectErrors');
            DOM.perfPublishErrorsEl = document.getElementById('perfPublishErrors');
            DOM.perfSubscribeFailuresEl = document.getElementById('perfSubscribeFailures');
            DOM.perfRecentLatenciesEl = document.getElementById('perfRecentLatencies');
            DOM.publishTopicEl = document.getElementById('publishTopic');
            DOM.publishPayloadEl = document.getElementById('publishPayload');
            DOM.publishQosEl = document.getElementById('publishQos');
            DOM.messageExpiryEl = document.getElementById('messageExpiry');
            DOM.publishTopicAliasEl = document.getElementById('publishTopicAlias');
            DOM.publishRetainEl = document.getElementById('publishRetain');
            DOM.publishButton = document.getElementById('publishButton');
            DOM.subscribeTopicEl = document.getElementById('subscribeTopic');
            DOM.subscribeQosEl = document.getElementById('subscribeQos');
            DOM.subNoLocalEl = document.getElementById('subNoLocal');
            DOM.subRetainAsPublishedEl = document.getElementById('subRetainAsPublished');
            DOM.subRetainHandlingEl = document.getElementById('subRetainHandling');
            DOM.subscribeButton = document.getElementById('subscribeButton');
            DOM.messageLogEl = document.getElementById('messageLog');
            DOM.noMessagesPlaceholder = document.getElementById('noMessagesPlaceholder');
            DOM.targetClientIdEl = document.getElementById('targetClientId'); 
            DOM.serviceOrTopicNameEl = document.getElementById('serviceOrTopicName'); 
            DOM.requestPayloadEl = document.getElementById('requestPayload');
            DOM.sendRequestButton = document.getElementById('sendRequestButton');
            DOM.requestResponseLogEl = document.getElementById('requestResponseLog');
            DOM.noReqResPlaceholder = document.getElementById('noReqResPlaceholder');

            setMqttUiState(false); 

            if (DOM.connectMqttButton) DOM.connectMqttButton.addEventListener('click', handleSubmitMqttLoginClick);
            if (DOM.disconnectMqttButton) DOM.disconnectMqttButton.addEventListener('click', handleDisconnectMqttClick);
            if (DOM.subscribeButton) DOM.subscribeButton.addEventListener('click', handleSubscribeClick);
            if (DOM.publishButton) DOM.publishButton.addEventListener('click', handlePublishClick);
            if (DOM.sendRequestButton) DOM.sendRequestButton.addEventListener('click', handleSendRequestClick);
            if (DOM.useWebsocketsEl) DOM.useWebsocketsEl.addEventListener('change', () => {
                DOM.websocketsOptionsEl.style.display = DOM.useWebsocketsEl.checked ? 'block' : 'none';
            });
            
            if (currentWebUser) {
                console.log("Web user authenticated, connecting Socket.IO.");
                socket.connect();
            } else {
                console.log("No web user authenticated, Socket.IO connection deferred.");
            }
        });

        function updateMqttStatus(message, type = 'info') { 
            if (!DOM.connectionStatusEl) return;
            DOM.connectionStatusEl.textContent = message;
            DOM.connectionStatusEl.classList.remove('bg-green-500', 'bg-red-500', 'bg-yellow-400', 'bg-sky-500', 'text-white', 'text-slate-800');
            
            switch (type) {
                case 'success': DOM.connectionStatusEl.classList.add('bg-green-500', 'text-white'); break;
                case 'error': DOM.connectionStatusEl.classList.add('bg-red-500', 'text-white'); break;
                case 'warning': DOM.connectionStatusEl.classList.add('bg-yellow-400', 'text-slate-800'); break;
                default: DOM.connectionStatusEl.classList.add('bg-sky-500', 'text-white'); break;
            }
        }
        
        function updateMqttLoginStatus(message, isError = false) { 
            if (!DOM.mqttLoginStatus) return;
            DOM.mqttLoginStatus.textContent = message;
            DOM.mqttLoginStatus.className = `mt-4 text-sm text-center h-5 ${isError ? 'text-red-600' : 'text-green-600'}`;
            DOM.connectMqttButton.disabled = false;
            DOM.mqttConnectSpinner.style.display = 'none';
        }

        socket.on('connect', () => { console.log('Socket.IO: Connected to backend.'); });
        socket.on('disconnect', () => { 
            console.log('Socket.IO: Disconnected from backend.');
            updateMqttStatus('Socket.IO Disconnected. MQTT operations paused.', 'error');
            setMqttUiState(false); 
        });
        socket.on('connect_error', (err) => {
            console.error('Socket.IO connection error:', err);
            updateMqttStatus(`Socket.IO Connection Error: ${err.message}. Try refreshing.`, 'error');
        });

        socket.on('request_mqtt_login', (data) => {
            console.log('Socket.IO: Backend requests MQTT login.', data.message);
            if (DOM.mqttLoginStatus) updateMqttLoginStatus(data.message, false);
        });

        socket.on('mqtt_login_status', (data) => {
            console.log('JS: Received mqtt_login_status:', data);
            if (data.success) {
                updateMqttLoginStatus(`MQTT Logged in as ${data.mqtt_username}!`, false);
                if (DOM.loggedInMqttUser) DOM.loggedInMqttUser.textContent = data.mqtt_username;
                if (DOM.loggedInMqttClientId) DOM.loggedInMqttClientId.textContent = data.mqtt_client_id || 'N/A';
                if (DOM.transportInfoEl) DOM.transportInfoEl.textContent = data.transport ? data.transport.toUpperCase() : 'N/A';
                if (DOM.secureInfoEl) DOM.secureInfoEl.textContent = data.secure ? 'Yes (TLS)' : 'No';
                setMqttUiState(true); 
            } else {
                updateMqttLoginStatus(data.message, true);
                setMqttUiState(false); 
            }
        });
        
        socket.on('mqtt_status', (data) => { 
            if (!DOM.connectionStatusEl) return;
            if (isMqttConnected || data.message.toLowerCase().includes('attempting')) { 
                if (data.message.toLowerCase().includes('connected as') || data.message.toLowerCase().includes('connected successfully')) {
                    updateMqttStatus(`MQTT: ${data.message}`, 'success');
                    if (!isMqttConnected) setMqttUiState(true); 
                } else if (data.message.toLowerCase().includes('failed') || data.message.toLowerCase().includes('error') || data.message.toLowerCase().includes('disconnected')) {
                    updateMqttStatus(`MQTT: ${data.message}`, 'error');
                    setMqttUiState(false); 
                } else if (data.message.toLowerCase().includes('connecting') || data.message.toLowerCase().includes('attempting')) {
                    updateMqttStatus(`MQTT: ${data.message}`, 'warning');
                } else { 
                    updateMqttStatus(`MQTT: ${data.message}`, 'info');
                }
            }
        });

        socket.on('mqtt_message', (data) => {
            if (!DOM.messageLogEl || !isMqttConnected) return;
            if (!hasReceivedMessages) {
                if(DOM.noMessagesPlaceholder) DOM.noMessagesPlaceholder.style.display = 'none';
                hasReceivedMessages = true;
            }
            const listItem = document.createElement('li');
            listItem.className = 'bg-white p-3 rounded-lg shadow-sm break-words';
            const escapedPayload = escapeHtml(data.payload);
            let latencyText = data.latency_ms !== null ? `<span class="text-purple-600">(Latency: ${data.latency_ms.toFixed(1)} ms)</span>` : "";
            let topicAliasInfo = data.topic_alias_used !== null ? `<span class="text-teal-700">(Alias: ${data.topic_alias_used})</span>` : "";
            
            listItem.innerHTML = `
                <div class="flex justify-between items-center mb-1">
                    <span class="font-semibold text-indigo-700">${data.topic}</span>
                    <span class="text-xs text-slate-400">${new Date().toLocaleTimeString()}</span>
                </div>
                <pre class="mt-1 text-slate-600 bg-slate-100 p-2 rounded-md text-xs whitespace-pre-wrap">${escapedPayload}</pre>
                <div class="mt-1 text-xs text-slate-500 flex justify-between items-center">
                    <span>QoS: ${data.qos} | Retain: ${data.retain ? 'Yes' : 'No'} ${topicAliasInfo}</span>
                    ${latencyText}
                </div>`;
            DOM.messageLogEl.prepend(listItem);
        });

        socket.on('publish_ack', (data) => { /* Optional */ });

        socket.on('mqtt_request_response_update', (data) => {
            if (!DOM.requestResponseLogEl || !isMqttConnected) return;
            if (firstReqResMessage) {
                if(DOM.noReqResPlaceholder) DOM.noReqResPlaceholder.style.display = 'none';
                DOM.requestResponseLogEl.innerHTML = ''; 
                firstReqResMessage = false;
            }
            const p = document.createElement('p');
            p.className = 'border-b border-slate-100 pb-2 mb-2 last:border-b-0 last:pb-0 last:mb-0';
            let content = `<strong class="font-semibold">[${data.type.toUpperCase()}]</strong> <span class="text-xs text-slate-400">CorrID: ${data.correlation_id || 'N/A'}</span>`;
            if (data.status) content += ` - Status: <span class="font-medium">${data.status}</span>`;
            if (data.message) content += ` - Msg: ${escapeHtml(data.message)}`;
            if (data.request_topic) content += ` <br><span class="text-xs">ReqTopic: ${escapeHtml(data.request_topic)}</span>`;
            if (data.response_topic_subscribed) content += ` <br><span class="text-xs">RespSub: ${escapeHtml(data.response_topic_subscribed)}</span>`;
            if (data.topic) content += ` <br><span class="text-xs">OnTopic: ${escapeHtml(data.topic)}</span>`;
            if (data.payload) content += `<br><pre class="text-xs bg-slate-100 p-1.5 rounded mt-1">${escapeHtml(data.payload)}</pre>`;
            if (data.latency_ms) content += ` <span class="text-xs text-purple-600">(Latency: ${data.latency_ms.toFixed(1)} ms)</span>`;
            
            if (data.type === 'error' || data.status === 'timeout') p.classList.add('text-red-600');
            else if (data.type === 'response' || data.status === 'completed') p.classList.add('text-green-600');
            else if (data.type === 'request_sent') p.classList.add('text-blue-600');
            else p.classList.add('text-slate-700');

            p.innerHTML = content;
            DOM.requestResponseLogEl.prepend(p);
        });

        socket.on('performance_update', (data) => {
            if (!isMqttConnected) return;
            if (DOM.perfMsgInRateEl) DOM.perfMsgInRateEl.textContent = data.msg_in_rate_mps.toFixed(1);
            if (DOM.perfMsgOutRateEl) DOM.perfMsgOutRateEl.textContent = data.msg_out_rate_mps.toFixed(1);
            if (DOM.perfBytesInRateEl) DOM.perfBytesInRateEl.textContent = formatBytes(data.bytes_in_rate_Bps);
            if (DOM.perfBytesOutRateEl) DOM.perfBytesOutRateEl.textContent = formatBytes(data.bytes_out_rate_Bps);
            if (DOM.perfConnectErrorsEl) DOM.perfConnectErrorsEl.textContent = data.total_connect_errors;
            if (DOM.perfPublishErrorsEl) DOM.perfPublishErrorsEl.textContent = data.total_publish_errors;
            if (DOM.perfSubscribeFailuresEl) DOM.perfSubscribeFailuresEl.textContent = data.total_subscribe_failures;
            if (DOM.perfRecentLatenciesEl) {
                DOM.perfRecentLatenciesEl.textContent = data.recent_latencies_ms.length > 0 
                    ? data.recent_latencies_ms.map(l => l.toFixed(1)).slice(-10).join(', ') + (data.recent_latencies_ms.length > 10 ? '...' : '')
                    : 'N/A';
            }
            if (DOM.brokerTopicAliasMaxInfoEl && data.broker_topic_alias_max !== undefined) {
                DOM.brokerTopicAliasMaxInfoEl.textContent = data.broker_topic_alias_max;
            }
        });

        function escapeHtml(unsafe) {
            if (typeof unsafe !== 'string') return String(unsafe);
            return unsafe.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
        }
        function formatBytes(bytes, decimals = 1) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const dm = decimals < 0 ? 0 : decimals;
            const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
        }

        function handleSubmitMqttLoginClick() { 
            DOM.connectMqttButton.disabled = true;
            DOM.mqttConnectSpinner.style.display = 'inline-block';
            updateMqttLoginStatus('Attempting MQTT connection...', false);

            const mqttLoginData = { 
                username: DOM.mqttUsernameEl.value.trim(),
                password: DOM.mqttPasswordEl.value,
                use_mqtts: DOM.useSecureConnectionEl.checked,
                use_websockets: DOM.useWebsocketsEl.checked,
                ws_path: DOM.useWebsocketsEl.checked ? DOM.wsPathEl.value.trim() : null,
                connect_topic_alias_max: DOM.connectTopicAliasMaxEl.value.trim() ? parseInt(DOM.connectTopicAliasMaxEl.value.trim(), 10) : null,
                lwt: null
            };
            const lwtTopic = DOM.lwtTopicEl.value.trim();
            if (lwtTopic) {
                mqttLoginData.lwt = {
                    topic: lwtTopic, payload: DOM.lwtPayloadEl.value,
                    qos: parseInt(DOM.lwtQosEl.value, 10), retain: DOM.lwtRetainEl.checked
                };
            }

            if (mqttLoginData.username && mqttLoginData.password) {
                if (socket.connected) { 
                    socket.emit('submit_mqtt_login', mqttLoginData);
                } else {
                     updateMqttLoginStatus('Socket.IO not connected. Please wait or refresh.', true);
                }
            } else {
                updateMqttLoginStatus('MQTT Username and password are required.', true);
            }
        }

        function handleDisconnectMqttClick() {
            console.log("JS: MQTT Disconnect clicked.");
            if (socket.connected) {
                socket.disconnect(); 
            }
            setMqttUiState(false); 
            updateMqttStatus("MQTT Disconnected by user.", "info");
        }

        function handleSubscribeClick() {
            if (!isMqttConnected) { alert("Connect to MQTT first!"); return; }
            const subData = {
                topic: DOM.subscribeTopicEl.value.trim(),
                qos: parseInt(DOM.subscribeQosEl.value, 10),
                no_local: DOM.subNoLocalEl.checked,
                retain_as_published: DOM.subRetainAsPublishedEl.checked,
                retain_handling: parseInt(DOM.subRetainHandlingEl.value, 10)
            };
            if (subData.topic && socket.connected) socket.emit('subscribe_to_topic', subData);
            else if (!socket.connected) alert("Socket.IO not connected. Please login to web app.");
            else alert("Please enter a topic to subscribe to.");
        }

        function handlePublishClick() {
            if (!isMqttConnected) { alert("Connect to MQTT first!"); return; }
            const pubData = {
                topic: DOM.publishTopicEl.value.trim(), payload: DOM.publishPayloadEl.value,
                qos: parseInt(DOM.publishQosEl.value, 10), retain: DOM.publishRetainEl.checked,
                client_publish_time_ms: new Date().getTime(),
                message_expiry_interval: DOM.messageExpiryEl.value.trim() ? parseInt(DOM.messageExpiryEl.value.trim(), 10) : null,
                topic_alias: DOM.publishTopicAliasEl.value.trim() ? parseInt(DOM.publishTopicAliasEl.value.trim(), 10) : null
            };
            if (pubData.message_expiry_interval !== null && pubData.message_expiry_interval <= 0) pubData.message_expiry_interval = null;

            if ((pubData.topic || (pubData.topic_alias !== null && pubData.topic_alias > 0)) && socket.connected) {
                socket.emit('publish_mqtt_message', pubData);
            } else if (!socket.connected) {
                alert("Socket.IO not connected. Please login to web app.");
            } else {
                alert("Please enter a topic (or a valid Topic Alias > 0) to publish to.");
            }
        }

        function handleSendRequestClick() {
            if (!isMqttConnected) { alert("Connect to MQTT first!"); return; }
            const reqData = {
                target_client_id: DOM.targetClientIdEl.value.trim(),
                service_or_topic_name: DOM.serviceOrTopicNameEl.value.trim(),
                request_payload: DOM.requestPayloadEl.value
            };

            if (reqData.service_or_topic_name && socket.connected) {
                socket.emit('send_mqtt_request', reqData);
                if (firstReqResMessage && DOM.requestResponseLogEl) { DOM.requestResponseLogEl.innerHTML = ''; firstReqResMessage = false; }
                const p = document.createElement('p');
                let requestDesc = reqData.target_client_id 
                    ? `Direct to ${escapeHtml(reqData.target_client_id)} for service ${escapeHtml(reqData.service_or_topic_name)}`
                    : `General to ${escapeHtml(reqData.service_or_topic_name)}`;

                p.innerHTML = `<strong class="font-semibold text-blue-600">[SENT REQUEST]</strong> ${requestDesc} <br><pre class="text-xs bg-slate-100 p-1.5 rounded mt-1">${escapeHtml(reqData.request_payload)}</pre>`;
                p.className = 'border-b border-slate-100 pb-2 mb-2 last:border-b-0 last:pb-0 last:mb-0';
                if (DOM.requestResponseLogEl) DOM.requestResponseLogEl.prepend(p);
            } else if (!socket.connected) {
                alert("Socket.IO not connected. Please login to web app.");
            } else {
                alert("Please enter a Service Name / General Topic for the request.");
            }
        }
    </script>
</body>
</html>